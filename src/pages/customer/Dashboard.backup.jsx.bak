import React, { useState } from "react";
import {
    Box,
    Typography,
    Card,
    CardContent,
    Grid,
    Avatar,
    Button,
    LinearProgress,
    Chip,
    Alert,
    Paper,
    List,
    ListItem,
    ListItemIcon,
    ListItemText,
    ListItemSecondaryAction,
    IconButton,
    Divider,
    Stack,
    Container,
} from "@mui/material";
import {
    ElectricCar,
    LocationOn,
    Schedule,
    Payment,
    QrCodeScanner,
    Battery80,
    Speed,
    AccessTime,
    Notifications,
    Star,
    MoreVert,
    TrendingUp,
    Flash,
    History,
    BatteryChargingFull,
    LocalGasStation,
    AccountBalanceWallet,
} from "@mui/icons-material";
import { useNavigate } from "react-router-dom";
import { formatCurrency } from "../../utils/helpers";
import useAuthStore from "../../store/authStore";
const CustomerDashboard = () => {
    const navigate = useNavigate();
    const { user } = useAuthStore();

    // Mock active charging session
    const [activeBooking] = useState({
        id: "B001",
        stationName: "Vincom Mega Mall - Tr·∫°m A01",
        progress: 65,
        currentSOC: 65,
        targetSOC: 80,
        estimatedTimeRemaining: 25, // minutes
        currentCost: 89000,
        chargingRate: 45, // kW
        energyDelivered: 18.5, // kWh
        status: "charging",
    });

    const quickActions = [
        {
            title: "T√¨m tr·∫°m s·∫°c",
            description: "Kh√°m ph√° tr·∫°m s·∫°c g·∫ßn nh·∫•t",
            icon: <LocationOn sx={{ fontSize: 28 }} />,
            color: "primary",
            gradient: "linear-gradient(135deg, #1976d2 0%, #42a5f5 100%)",
            action: () => navigate("/customer/find-stations"),
        },
        {
            title: "Qu√©t QR s·∫°c ngay",
            description: "B·∫Øt ƒë·∫ßu phi√™n s·∫°c nhanh ch√≥ng",
            icon: <QrCodeScanner sx={{ fontSize: 28 }} />,
            color: "success", 
            gradient: "linear-gradient(135deg, #388e3c 0%, #66bb6a 100%)",
            action: () => navigate("/qr-demo"),
        },
        {
            title: "L·ªãch s·ª≠ & Th·ªëng k√™",
            description: "Xem b√°o c√°o s·∫°c chi ti·∫øt",
            icon: <TrendingUp sx={{ fontSize: 28 }} />,
            color: "info",
            gradient: "linear-gradient(135deg, #0288d1 0%, #29b6f6 100%)",
            action: () => navigate("/customer/analytics"),
        },
        {
            title: "Ph∆∞∆°ng th·ª©c thanh to√°n",
            description: "Qu·∫£n l√Ω v√≠ v√† th·∫ª thanh to√°n",
            icon: <Payment sx={{ fontSize: 28 }} />,
            color: "warning",
            gradient: "linear-gradient(135deg, #f57c00 0%, #ffb74d 100%)",
            action: () => navigate("/customer/payment"),
        },
    ];

    const recentBookings = [
        {
            id: "B002",
            stationName: "AEON Mall B√¨nh T√¢n",
            date: "29/09/2025",
            energy: 32.5,
            cost: 176000,
            status: "completed",
            rating: 5,
        },
        {
            id: "B003",
            stationName: "Lotte Mart G√≤ V·∫•p",
            date: "27/09/2025",
            energy: 28.0,
            cost: 152000,
            status: "completed",
            rating: 4,
        },
        {
            id: "B004",
            stationName: "Big C ThƒÉng Long",
            date: "25/09/2025",
            energy: 35.2,
            cost: 191000,
            status: "completed",
            rating: null,
        },
    ];

    const getStatusColor = (status) => {
        switch (status) {
            case "charging": return "primary";
            case "completed": return "success";
            case "cancelled": return "error";
            default: return "default";
        }
    };

    const getStatusText = (status) => {
        switch (status) {
            case "charging": return "ƒêang s·∫°c";
            case "completed": return "Ho√†n th√†nh";
            case "cancelled": return "ƒê√£ h·ªßy";
            default: return status;
        }
    };

    return (
        <Container maxWidth="xl" sx={{ py: 2 }}>
            {/* Welcome Header with modern design */}
            <Box 
                sx={{ 
                    mb: 4,
                    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                    borderRadius: 4,
                    p: 4,
                    color: "white",
                    position: "relative",
                    overflow: "hidden",
                    "&::before": {
                        content: '""',
                        position: "absolute",
                        top: 0,
                        right: 0,
                        width: "40%", 
                        height: "100%",
                        background: "url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"40\" fill=\"none\" stroke=\"%23ffffff\" stroke-width=\"0.5\" opacity=\"0.1\"/></svg>') repeat",
                        opacity: 0.1,
                    }
                }}
            >
                <Stack direction={{ xs: "column", md: "row" }} spacing={3} alignItems="center">
                    <Avatar 
                        sx={{ 
                            width: 80, 
                            height: 80, 
                            background: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                            fontSize: "2rem",
                            fontWeight: "bold"
                        }}
                    >
                        {user?.profile?.firstName?.[0] || user?.name?.[0] || 'U'}
                    </Avatar>
                    <Box sx={{ flex: 1, textAlign: { xs: "center", md: "left" } }}>
                        <Typography variant="h4" fontWeight="bold" gutterBottom>
                            Xin ch√†o, {user?.profile?.firstName || user?.name?.split(' ')[0] || 'B·∫°n'}! 
                        </Typography>
                <Typography variant="body1" color="text.secondary">
                    Qu·∫£n l√Ω vi·ªác s·∫°c xe ƒëi·ªán c·ªßa b·∫°n m·ªôt c√°ch d·ªÖ d√†ng
                </Typography>
            </Box>

            {/* Active Charging Session */}
            {activeBooking && (
                <Alert
                    severity="info"
                    sx={{
                        mb: 4,
                        border: 2,
                        borderColor: "primary.main",
                        bgcolor: "primary.50"
                    }}
                >
                    <Box>
                        <Typography variant="h6" fontWeight="bold" gutterBottom>
                            üîã Phi√™n s·∫°c ƒëang ho·∫°t ƒë·ªông
                        </Typography>
                        <Grid container spacing={2} alignItems="center">
                            <Grid item xs={12} md={6}>
                                <Typography variant="body1" fontWeight="medium">
                                    üìç {activeBooking.stationName}
                                </Typography>
                                <Typography variant="body2" color="text.secondary">
                                    ‚ö° {activeBooking.chargingRate} kW ‚Ä¢ üîã {activeBooking.currentSOC}% ‚Üí {activeBooking.targetSOC}%
                                </Typography>
                                <Box sx={{ mt: 1, mb: 1 }}>
                                    <LinearProgress
                                        variant="determinate"
                                        value={activeBooking.progress}
                                        sx={{ height: 8, borderRadius: 4 }}
                                    />
                                </Box>
                                <Typography variant="caption" color="text.secondary">
                                    ‚è±Ô∏è C√≤n l·∫°i ~{activeBooking.estimatedTimeRemaining} ph√∫t ‚Ä¢ üí∞ {formatCurrency(activeBooking.currentCost)}
                                </Typography>
                            </Grid>
                            <Grid item xs={12} md={6} sx={{ textAlign: { xs: "left", md: "right" } }}>
                                <Button
                                    variant="contained"
                                    sx={{ mr: 1, mb: { xs: 1, md: 0 } }}
                                    onClick={() => navigate("/customer/history")}
                                >
                                    Xem chi ti·∫øt
                                </Button>
                                <Button
                                    variant="outlined"
                                    color="error"
                                >
                                    D·ª´ng s·∫°c
                                </Button>
                            </Grid>
                        </Grid>
                    </Box>
                </Alert>
            )}

            <Grid container spacing={3}>
                {/* Quick Actions */}
                <Grid item xs={12} md={8}>
                    <Card>
                        <CardContent>
                            <Typography variant="h6" fontWeight="bold" gutterBottom>
                                Thao t√°c nhanh
                            </Typography>
                            <Grid container spacing={2}>
                                {quickActions.map((action, index) => (
                                    <Grid item xs={12} sm={6} key={index}>
                                        <Paper
                                            sx={{
                                                p: 2,
                                                cursor: "pointer",
                                                border: "1px solid",
                                                borderColor: "divider",
                                                transition: "all 0.2s",
                                                "&:hover": {
                                                    borderColor: `${action.color}.main`,
                                                    transform: "translateY(-2px)",
                                                    boxShadow: 2,
                                                },
                                            }}
                                            onClick={action.action}
                                        >
                                            <Box sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                                                <Avatar
                                                    sx={{
                                                        bgcolor: `${action.color}.main`,
                                                        width: 48,
                                                        height: 48,
                                                    }}
                                                >
                                                    {action.icon}
                                                </Avatar>
                                                <Box>
                                                    <Typography variant="subtitle1" fontWeight="medium">
                                                        {action.title}
                                                    </Typography>
                                                    <Typography variant="body2" color="text.secondary">
                                                        {action.description}
                                                    </Typography>
                                                </Box>
                                            </Box>
                                        </Paper>
                                    </Grid>
                                ))}
                            </Grid>
                        </CardContent>
                    </Card>

                    {/* Recent Sessions */}
                    <Card sx={{ mt: 3 }}>
                        <CardContent>
                            <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}>
                                <Typography variant="h6" fontWeight="bold">
                                    Phi√™n s·∫°c g·∫ßn ƒë√¢y
                                </Typography>
                                <Button
                                    size="small"
                                    onClick={() => navigate("/customer/history")}
                                >
                                    Xem t·∫•t c·∫£
                                </Button>
                            </Box>
                            <List>
                                {recentBookings.map((booking, index) => (
                                    <React.Fragment key={booking.id}>
                                        <ListItem sx={{ px: 0 }}>
                                            <ListItemIcon>
                                                <Avatar sx={{ bgcolor: "primary.light" }}>
                                                    <ElectricCar />
                                                </Avatar>
                                            </ListItemIcon>
                                            <ListItemText
                                                primary={booking.stationName}
                                                secondary={
                                                    <Box>
                                                        <Typography variant="caption" display="block">
                                                            {booking.date} ‚Ä¢ {booking.energy} kWh ‚Ä¢ {formatCurrency(booking.cost)}
                                                        </Typography>
                                                        <Box sx={{ display: "flex", alignItems: "center", gap: 1, mt: 0.5 }}>
                                                            <Chip
                                                                label={getStatusText(booking.status)}
                                                                size="small"
                                                                color={getStatusColor(booking.status)}
                                                            />
                                                            {booking.rating && (
                                                                <Box sx={{ display: "flex", alignItems: "center", gap: 0.5 }}>
                                                                    <Star sx={{ fontSize: 14, color: "warning.main" }} />
                                                                    <Typography variant="caption">{booking.rating}</Typography>
                                                                </Box>
                                                            )}
                                                        </Box>
                                                    </Box>
                                                }
                                            />
                                            <ListItemSecondaryAction>
                                                <IconButton size="small">
                                                    <MoreVert />
                                                </IconButton>
                                            </ListItemSecondaryAction>
                                        </ListItem>
                                        {index < recentBookings.length - 1 && <Box sx={{ height: 8 }} />}
                                    </React.Fragment>
                                ))}
                            </List>
                        </CardContent>
                    </Card>
                </Grid>

                {/* Sidebar */}
                <Grid item xs={12} md={4}>
                    {/* Quick Stats */}
                    <Card sx={{ mb: 3 }}>
                        <CardContent>
                            <Typography variant="h6" fontWeight="bold" gutterBottom>
                                T·ªïng quan th√°ng n√†y
                            </Typography>
                            <Box sx={{ mb: 3 }}>
                                <Box sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}>
                                    <Typography variant="body2">S·ªë l·∫ßn s·∫°c</Typography>
                                    <Typography variant="h6" color="primary.main" fontWeight="bold">15</Typography>
                                </Box>
                                <Box sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}>
                                    <Typography variant="body2">T·ªïng chi ph√≠</Typography>
                                    <Typography variant="h6" color="success.main" fontWeight="bold">
                                        {formatCurrency(2450000)}
                                    </Typography>
                                </Box>
                                <Box sx={{ display: "flex", justifyContent: "space-between", mb: 1 }}>
                                    <Typography variant="body2">NƒÉng l∆∞·ª£ng</Typography>
                                    <Typography variant="h6" color="info.main" fontWeight="bold">450 kWh</Typography>
                                </Box>
                            </Box>
                            <Button
                                variant="outlined"
                                fullWidth
                                onClick={() => navigate("/customer/analytics")}
                            >
                                Xem ph√¢n t√≠ch chi ti·∫øt
                            </Button>
                        </CardContent>
                    </Card>

                    {/* Notifications */}
                    <Card>
                        <CardContent>
                            <Typography variant="h6" fontWeight="bold" gutterBottom>
                                <Notifications sx={{ mr: 1, verticalAlign: "middle" }} />
                                Th√¥ng b√°o
                            </Typography>
                            <Box sx={{ mb: 2 }}>
                                <Alert severity="success" sx={{ mb: 2 }}>
                                    <Typography variant="body2">
                                        üéâ B·∫°n ƒë√£ ti·∫øt ki·ªám ƒë∆∞·ª£c 15% chi ph√≠ s·∫°c th√°ng n√†y!
                                    </Typography>
                                </Alert>
                                <Alert severity="info">
                                    <Typography variant="body2">
                                        ‚ö° Tr·∫°m s·∫°c Vincom Mega Mall c√≥ khuy·∫øn m√£i 20% v√†o cu·ªëi tu·∫ßn
                                    </Typography>
                                </Alert>
                            </Box>
                        </CardContent>
                    </Card>
                </Grid>
            </Grid>
        </Box>
    );
};

export default CustomerDashboard;